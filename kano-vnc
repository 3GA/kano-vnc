#!/bin/sh

# kano-vnc
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#
# A script for toggling the VNC server
#

VNC_PATH=~/.vnc
PASS_FILE=~/.vnc/passwd
PID_FILE=~/.vnc/kano\:1.pid
DIALOG_FILE=/usr/lib/python2.7/dist-packages/kano/gtk3/kano_dialog.py

if [ ! -d "$VNC_PATH" ]; then
    mkdir $VNC_PATH
fi

# kano-profile stat collection
if [ -e /usr/bin/kano-profile-cli ]; then
    kano-profile-cli increment_app_state_variable vnc starts 1
fi

# Check if server already running
if [ -e $PID_FILE ]; then
    # Disable the server
    vncserver -kill ":1" >/dev/null 2>/dev/null
    python $DIALOG_FILE title="The VNC Server was disabled"
    # Remove .vnc folder
    rm -rf -- $VNC_PATH
else
    # Check for internet
    /usr/bin/is_internet
    if [ $? -ne 0 ]; then
        # Show message
        python $DIALOG_FILE title="Error!" description="Make sure you have internet connection"
        exit 1
    fi
    # Ask for password
    while true; do

        PASSWORD=`python $DIALOG_FILE title="Create a password (6 to 8 characters)" entry=hidden`
        if [ $? = "" ]; then
            exit 1
        elif [ ${#PASSWORD} -ge 6 ] && [ ${#PASSWORD} -le 8 ]; then
            break;
        fi
    done
    # Create encrypted password file
    echo "$PASSWORD\n$PASSWORD" | vncpasswd -f  > $PASS_FILE
    # Set correct permissions (-rw-------)
    chmod 0600 $PASS_FILE
    # Enable the server
    vncserver -name "kano" >/dev/null 2>/dev/null
    if [ -e $PID_FILE ]; then
        # Get Ethernet ip
        IP=`/sbin/ifconfig eth0 | grep inet | awk '{print $2}' | cut -d':' -f2`
        # Get wlan0 IP if needed
        if [ -z $IP ]; then
            IP=`/sbin/ifconfig wlan0 | grep inet | awk '{print $2}' | cut -d':' -f2`
        fi
        # Confirmation message
        python $DIALOG_FILE title="The VNC Server was enabled" description="IP is $IP:1"
    else
        # Error message
        python $DIALOG_FILE title="Error!" description="Something went wrong"
        exit 1
    fi
fi

exit 0
